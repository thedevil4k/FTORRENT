name: Build FLTorrent

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  release:
    needs: [build-windows, build-linux]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: fltorrent-windows
          path: ./artifacts

      - name: Download DEB Artifact
        uses: actions/download-artifact@v4
        with:
          name: FTorrent-deb
          path: ./artifacts

      - name: Download RPM Artifact
        uses: actions/download-artifact@v4
        with:
          name: FTorrent-rpm
          path: ./artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./artifacts/*.exe
            ./artifacts/*.deb
            ./artifacts/*.rpm
          generate_release_notes: true
          draft: false
          prerelease: false
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          C:/vcpkg/installed
          C:/vcpkg/archives
        key: vcpkg-windows-${{ runner.os }}-${{ hashFiles('CMakeLists.txt') }}
        restore-keys: |
          vcpkg-windows-${{ runner.os }}-

    - name: Install dependencies
      run: |
<<<<<<< Updated upstream
        git clone https://github.com/microsoft/vcpkg.git
        .\vcpkg\bootstrap-vcpkg.bat
        .\vcpkg\vcpkg install fltk libtorrent[pthreads] zlib libpng libjpeg-turbo --triplet x64-windows
=======
        vcpkg install fltk libtorrent zlib libpng libjpeg-turbo --triplet x64-windows
>>>>>>> Stashed changes

    - name: Configure CMake
      run: |
        cmake -S . -B build "-DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=x64-windows

    - name: Build
      run: |
        cmake --build build --config Release

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fltorrent-windows
        path: build/Release/FLTorrent.exe

  build-linux:
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4

    - name: Install Dependencies
      run: bash scripts/linux/setup/setup-linux.sh

    - name: Build Project
      run: bash scripts/linux/compilation/build-linux.sh
      env:
        BUILD_DIR: build_linux

    - name: Create Debian Package
      run: bash scripts/linux/installers/create-linux-deb.sh
      env:
        BUILD_DIR: build_linux

    - name: Create RPM Package
      run: bash scripts/linux/installers/create-linux-rpm.sh
      env:
        BUILD_DIR: build_linux

    - name: Upload DEB Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FTorrent-deb
        path: build_linux/*.deb

    - name: Upload RPM Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FTorrent-rpm
        path: build_linux/*.rpm
