name: Build FLTorrent

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'trackersadd.txt'
  pull_request:
    branches: [ main, master ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'trackersadd.txt'

jobs:
  release:
    needs: [build-windows, build-linux]
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Create Tagged Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./artifacts/*.exe
            ./artifacts/*.zip
            ./artifacts/*.deb
            ./artifacts/*.rpm
          generate_release_notes: true
          draft: false
          prerelease: false

      - name: Create Continuous Release (Latest)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build
          files: |
            ./artifacts/*.exe
            ./artifacts/*.zip
            ./artifacts/*.deb
            ./artifacts/*.rpm
          generate_release_notes: false
          draft: false
          prerelease: true
  build-windows:
    strategy:
      matrix:
        arch: [x64, arm64]
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          C:/vcpkg/installed
          C:/vcpkg/archives
        key: vcpkg-windows-${{ matrix.arch }}-${{ hashFiles('CMakeLists.txt') }}
        restore-keys: |
          vcpkg-windows-${{ matrix.arch }}-

    - name: Install NSIS
      run: |
        choco install nsis -y

    - name: Install dependencies
      run: |
        vcpkg install fltk libtorrent zlib libpng libjpeg-turbo --triplet ${{ matrix.arch }}-windows
        if ("${{ matrix.arch }}" -eq "arm64") { vcpkg install fltk --triplet x64-windows }

    - name: Configure CMake
      run: |
        $arch_flag = if ("${{ matrix.arch }}" -eq "arm64") { "-A ARM64" } else { "" }
        cmake -S . -B build "-DCMAKE_TOOLCHAIN_FILE=$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" -DVCPKG_TARGET_TRIPLET=${{ matrix.arch }}-windows $arch_flag

    - name: Build
      run: |
        cmake --build build --config Release

    - name: Generate Installer
      working-directory: build
      run: |
        cpack -G "NSIS;ZIP" -C Release

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fltorrent-windows-${{ matrix.arch }}
        path: |
          build/*.exe
          build/*.zip

  build-linux:
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, i386]
    runs-on: ubuntu-24.04
    container:
      image: ${{ matrix.arch == 'i386' && 'i386/debian:bookworm' || 'ubuntu:24.04' }}
    steps:
    - uses: actions/checkout@v4

    - name: Install sudo (if missing in container)
      run: |
        apt-get update && apt-get install -y sudo
      if: matrix.arch == 'i386'

    - name: Install Dependencies
      run: bash scripts/linux/setup/setup-linux.sh

    - name: Build Project
      run: bash scripts/linux/compilation/build-linux.sh
      env:
        BUILD_DIR: build_linux_${{ matrix.arch }}

    - name: Create Debian Package
      run: bash scripts/linux/installers/create-linux-deb.sh
      env:
        BUILD_DIR: build_linux_${{ matrix.arch }}

    - name: Create RPM Package
      run: bash scripts/linux/installers/create-linux-rpm.sh
      env:
        BUILD_DIR: build_linux_${{ matrix.arch }}

    - name: Upload DEB Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FTorrent-deb-${{ matrix.arch }}
        path: build_linux_${{ matrix.arch }}/*.deb

    - name: Upload RPM Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FTorrent-rpm-${{ matrix.arch }}
        path: build_linux_${{ matrix.arch }}/*.rpm
